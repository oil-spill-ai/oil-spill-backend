# Oil Spill Detection Backend

## Описание

Backend реализует REST API для загрузки архивов изображений, их обработки через ML микросервис (сегментация разливов нефти) и скачивания результатов. Поддерживается асинхронная обработка с помощью Celery и Redis.

---

## Архитектура

- **FastAPI** — основной REST API.
- **Celery + Redis** — асинхронная обработка изображений и периодическая очистка старых файлов.
- **ML микросервис** — внешний сервис для сегментации (по HTTP, см. переменную ML_SERVICE_URL).
- **Docker** — контейнеризация.

### Основные директории и файлы
- `app/main.py` — точка входа FastAPI, подключение маршрутов и CORS.
- `app/api.py` — основные API endpoints.
- `app/tasks.py` — задачи Celery (обработка изображений, очистка файлов).
- `app/celery_app.py` — конфигурация Celery.
- `app/utils.py` — работа с архивами.
- `app/upload_handler.py` — генерация job_id (используется опционально).
- `app/classify_service.py`, `app/segment_service.py` — примеры микросервисов (для тестов).
- `requirements.txt` — зависимости.
- `Dockerfile` — контейнеризация backend.

---

## Запуск

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Запустите Redis (локально или в Docker):
   ```bash
   docker run -p 6379:6379 redis
   ```
3. Запустите Celery воркеры и beat:
   ```bash
   celery -A app.tasks worker --loglevel=info
   celery -A app.tasks beat --loglevel=info
   ```
4. Запустите FastAPI backend:
   ```bash
   uvicorn app.main:app --reload
   ```
5. Запустите ML микросервис (см. директорию `ml`).

---

## Описание API

### POST `/api/upload/`
Загрузка zip-архива с изображениями. Запускает асинхронную обработку.
- **Ответ:** `{ job_id, task_ids, status }`

### GET `/api/task/{task_id}`
Статус задачи обработки.
- **Ответ:** `{ task_id, status, result }`

### GET `/api/archive/{job_id}`
Сформировать архив с результатами (после завершения обработки). Возвращает ссылку на скачивание архива.
- **Ответ:** `{ archive_url }`

### GET `/api/download/{filename}`
Скачать архив с результатами.

---

## Интеграция с ML микросервисом
- Вся обработка изображений происходит через внешний ML сервис (см. `ML_SERVICE_URL` в `tasks.py`).
- Backend не содержит ML моделей, только проксирует задачи.
- **Настройка адреса ML сервиса:**
  - По умолчанию ML_SERVICE_URL = http://localhost:8002
  - Для смены адреса используйте переменную окружения ML_SERVICE_URL, например:
    ```bash
    export ML_SERVICE_URL="http://ml:8002"
    ```

---

## Безопасность и рекомендации
- Ограничьте размер загружаемых архивов (см. max_upload_size в main.py).
- Архив с результатами формируется только по отдельному запросу, чтобы избежать скачивания пустых архивов.
- Периодическая задача очищает только директорию media. Рекомендуется добавить очистку uploads/results.
- Не используйте одинаковые имена файлов для разных job_id.
- Не храните чувствительные данные в публичных директориях.

---

## Авторы и лицензия
- Лицензия: см. LICENSE
- Авторы: Oil Spill Detection Team